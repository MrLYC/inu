# 任务: 添加交互式 Web 界面

## 阶段 1: 前端基础设施（基础）

### 创建静态文件结构
- [x] 创建 `pkg/web/static/` 目录
- [x] 创建 `pkg/web/static/index.html`，包含基本 HTML 结构
- [x] 创建 `pkg/web/static/styles.css`，包含响应式布局
- [x] 创建 `pkg/web/static/app.js`，包含模块结构

### 为服务器添加静态文件服务
- [x] 更新 `pkg/web/server.go` 添加 `GET /` 路由
- [x] 为 `/static/*` 路由配置 Gin 的静态文件处理器
- [x] 确保静态路由无需认证（公开访问）
- [x] 测试：`curl http://localhost:8080/` 返回 HTML

## 阶段 2: 匿名化视图（核心功能）

### 构建实体类型选择器
- [x] 在 HTML 中添加实体类型下拉菜单
- [x] 从 URL 参数填充下拉菜单（例如 `?types=PERSON,ORG,EMAIL`）
- [x] 添加"+ 添加自定义类型"按钮和输入对话框
- [x] 启用实体类型多选
- [x] 测试：可以选择和取消选择多个类型

### 构建输入/输出面板
- [x] 创建左侧输入文本区域（可编辑）
- [x] 创建右侧输出 div（只读，使用 pre-wrap）
- [x] 桌面端 50/50 分栏，移动端堆叠的样式
- [x] 添加带加载状态的"匿名化"按钮（旋转图标）
- [x] 测试：在 1920x1080 和 375x667 下布局响应

### 集成匿名化 API
- [x] 在 app.js 中添加调用 `POST /api/v1/anonymize` 的 `anonymize()` 函数
- [x] 使用凭据提示处理 401 响应（使用 window.prompt 输入用户名/密码）
- [x] 在内存中存储 Basic Auth 凭据（JavaScript 变量，不存 localStorage）
- [x] 成功时在右侧面板显示匿名化结果
- [x] 显示 400/500 响应的错误消息
- [x] 测试：匿名化"张三在阿里巴巴工作" → 看到"[PERSON_1]在[ORG_1]工作"

### 添加状态管理
- [x] 匿名化成功后在 sessionStorage 中存储 entities、anonymizedText、entityTypes
- [x] 添加"切换到还原模式"按钮（默认隐藏，匿名化后显示）
- [x] 测试：匿名化后刷新页面，验证状态恢复

## 阶段 3: 还原视图（高级功能）

### 构建还原视图 UI
- [x] 创建还原视图 HTML 结构（默认隐藏）
- [x] 在顶部添加实体映射显示（只读、可滚动）
- [x] 创建左侧匿名化文本面板（只读）
- [x] 创建右侧可编辑输入文本区域
- [x] 添加"还原"和"返回匿名化"按钮
- [x] 测试：在视图间切换，验证布局

### 视图切换逻辑
- [x] 添加 `switchToRestoreView()` 函数隐藏匿名化视图，显示还原视图
- [x] 添加 `switchToAnonymizeView()` 函数反向切换
- [x] 切换时从 sessionStorage 填充还原视图
- [x] 测试：来回切换，验证状态保留

### 集成还原 API
- [x] 在 app.js 中添加调用 `POST /api/v1/restore` 的 `restore()` 函数
- [x] 在请求体中使用 sessionStorage 中的实体
- [x] 成功时用还原后的文本更新右侧面板
- [x] 处理错误（400/500）并显示消息
- [x] 测试：还原"[PERSON_1]的新邮箱是[EMAIL_1]" → 看到"张三的新邮箱是zhangsan@example.com"

### 支持多次还原周期
- [x] 确保实体在多次"还原"点击中持久化
- [x] 每次还原前清除右侧面板（或根据需要追加）
- [x] 测试：使用相同实体还原 3 个不同文本

## 阶段 4: 错误处理和用户体验优化

### 客户端验证
- [x] 添加空输入验证（API 调用前显示错误）
- [x] 验证错误时高亮输入框红色边框
- [x] 添加防抖防止快速点击按钮（500ms）
- [x] 测试：尝试匿名化空文本，看到错误且无 API 调用

### 加载状态
- [x] API 调用期间在按钮中显示旋转图标
- [x] 加载期间禁用按钮
- [x] 匿名化期间在输出面板显示"处理中..."
- [x] 测试：长文本（>1000 字符），验证加载指示器可见

### 错误消息
- [x] 清晰格式化错误消息（红色文本、图标）
- [x] 区分 401（凭据提示）、400（用户错误）、500（服务器错误）
- [x] 添加网络错误处理（fetch 失败）
- [x] 测试：停止服务器，尝试匿名化，看到"无法连接到服务器"消息

## 阶段 5: 响应式设计

### 桌面端优化（>768px）
- [x] 确保输入/输出面板左右分栏布局
- [x] 为容器设置最大宽度（例如 1200px）以提高可读性
- [x] 实体映射溢出时添加横向滚动条
- [x] 测试：在 1920x1080 下的 Chrome、Firefox、Safari

- [x] 测试：在 1920x1080 下的 Chrome、Firefox、Safari

### 移动端优化（<768px）
- [x] 切换到堆叠布局（flexbox column）
- [x] 实体选择器全宽下拉菜单
- [x] 按钮设为全宽以便点击
- [x] 实体映射添加纵向滚动
- [x] 测试：Chrome DevTools 移动端模拟（iPhone SE、Pixel 5）

## 阶段 6: 测试和文档

### 手动测试
- [x] 测试完整匿名化流程：输入 → 匿名化 → 查看结果
- [x] 测试完整还原流程：切换模式 → 输入 → 还原 → 查看结果
- [x] 测试使用相同实体的多次还原周期
- [x] 测试跨页面刷新的状态持久化
- [x] 测试新匿名化后的状态清除
- [x] 测试错误场景（401、400、500、网络故障）
- [x] 测试多设备响应式设计

### 浏览器兼容性
- [x] Chrome（最新版）
- [x] Firefox（最新版）
- [x] Safari（最新版，macOS 和 iOS）
- [x] Edge（最新版）

### 文档
- [x] 使用 Web UI 更新 README.md
- [x] 添加匿名化和还原视图的截图
- [x] 记录 URL 参数（例如 `?types=PERSON,ORG`）
- [x] 添加故障排除部分（常见错误）

## 阶段 7: 验证和发布

### OpenSpec 验证
- [x] 运行 `openspec validate add-interactive-web-ui --strict`
- [x] 修复任何验证错误（缺失场景、错误状态）
- [x] 确保所有要求至少有 2 个场景

### 代码审查
- [x] 自我审查 HTML/CSS/JS 的可读性和可维护性
- [x] 检查 XSS 漏洞（使用 textContent，不用 innerHTML）
- [x] 验证认证逻辑（凭据仅存内存）
- [x] 确认静态文件无需认证即可访问

### 构建和部署
- [x] 运行 `make build` 验证无编译错误
- [x] 测试构建的二进制文件：`./bin/inu web --admin-token=secret`
- [x] 打开 `http://localhost:8080/` 并验证 UI 加载
- [x] 在构建的二进制文件上执行端到端测试

### 任务完成
- [x] 将 tasks.md 中的所有任务标记为 ✓ 完成
- [x] 如需要，更新 proposal.md 的"状态：已实现"
- [x] 准备使用 `openspec archive add-interactive-web-ui` 归档
