# Implementation Tasks

## 1. 实现占位符归一化功能

- [x] 1.1 在 `pkg/anonymizer/anonymizer.go` 中添加 `normalizePlaceholder` 函数
  - 输入：原始占位符字符串（例如 `< 业务信息 [2]. 系统。名称 >`）
  - 输出：归一化后的占位符字符串（例如 `<业务信息[2].系统.名称>`）
  - 实现步骤：提取内容 → 移除空格 → 转换标点 → 转换全角/半角 → 重新包装
  
- [x] 1.2 添加 `normalizePlaceholder` 单元测试到 `pkg/anonymizer/anonymizer_test.go`
  - 测试标准格式不变：`<个人信息[0].姓名.全名>` → `<个人信息[0].姓名.全名>`
  - 测试移除空格：`< 个人信息 [0]. 姓名. 全名 >` → `<个人信息[0].姓名.全名>`
  - 测试中文标点转换：`<业务信息[2]。系统。名称>` → `<业务信息[2].系统.名称>`
  - 测试全角字符转换：`<账户信息[　０　].银行>` → `<账户信息[0].银行>`
  - 测试混合变化：`< 业务信息 [2]。 系统 。 名称 >` → `<业务信息[2].系统.名称>`
  - 测试非占位符文本：`"not a placeholder"` → `"not a placeholder"`（不变）

- [x] 1.3 添加预编译正则表达式
  - 在包级别定义 `var placeholderRegex = regexp.MustCompile(\`<[^>]+>\`)`
  - 避免在 `RestoreText` 中重复编译正则表达式

## 2. 修改 RestoreText 实现

- [x] 2.1 重构 `RestoreText` 方法使用归一化匹配
  - 构建归一化实体映射：`map[normalizedKey]originalValue`
  - 使用正则表达式 `placeholderRegex.ReplaceAllStringFunc` 查找和替换占位符
  - 对每个找到的占位符进行归一化，然后在映射中查找
  - 如果找到匹配，替换为原始值；如果未找到，保留占位符原样

- [x] 2.2 添加 `RestoreText` 格式兼容性测试到 `pkg/anonymizer/anonymizer_test.go`
  - 测试标准格式仍然工作（向后兼容）
  - 测试还原包含额外空格的占位符
  - 测试还原包含中文标点的占位符
  - 测试还原包含全角字符的占位符
  - 测试还原混合格式变化的占位符
  - 测试部分占位符无法匹配时的行为（部分还原）
  - 测试多个占位符的文本

## 3. 端到端测试

- [x] 3.1 创建集成测试场景
  - 准备测试数据：包含格式变化的脱敏文本和对应的实体文件
  - 测试 `restore` 命令能够正确处理格式变化
  - 验证输出结果与预期一致

- [x] 3.2 测试交互式命令场景
  - 手动测试 `inu interactive` 工作流
  - 验证从 ChatGPT 粘贴带格式变化的文本能够正确还原
  - 确认用户体验符合预期

## 4. 性能验证

- [x] 4.1 运行性能基准测试
  - 比较修改前后的 `RestoreText` 性能
  - 使用不同大小的文本（100 字符、1K、10K）
  - 使用不同数量的实体（10、50、100）
  - 确保性能退化 <10%

- [x] 4.2 优化（如果需要）
  - 如果性能测试显示显著退化，考虑优化策略
  - 可选：添加缓存机制（如果归一化成为瓶颈）

## 5. 文档和清理

- [x] 5.1 添加函数文档注释
  - `normalizePlaceholder` 函数添加详细注释，说明归一化规则
  - `RestoreText` 方法更新注释，说明支持格式兼容性

- [x] 5.2 更新 README（如果需要）
  - 检查 README.md 是否需要说明占位符格式容错功能
  - 如果有相关的疑难解答部分，添加说明

- [x] 5.3 运行完整测试套件
  - 执行 `go test ./...` 确保所有测试通过
  - 检查测试覆盖率是否符合标准

## 6. 验证和提交

- [x] 6.1 运行 OpenSpec 验证
  - 执行 `openspec validate improve-placeholder-compatibility --strict`
  - 修复任何验证错误

- [x] 6.2 代码质量检查
  - 运行 `golangci-lint run` 确保代码质量
  - 运行 `gofmt -s -w .` 确保代码格式化

- [x] 6.3 构建和手动测试
  - 执行 `make build` 构建项目
  - 手动测试常见使用场景
  - 验证错误处理和边缘案例

## Dependencies

- **无阻塞依赖**：所有任务可以按顺序完成
- **并行机会**：
  - 1.2 和 1.3 可以在 1.1 完成后并行开始
  - 3.1 和 3.2 可以在 2.2 完成后并行开始

## Validation Criteria

每个任务完成后，应该：
- [x] 代码通过 `go test` 和 `golangci-lint`
- [x] 相关的单元测试已添加并通过
- [x] 功能符合设计文档中的规范
- [x] 向后兼容性得到验证（现有测试仍然通过）
