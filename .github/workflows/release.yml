name: Release

on:
    push:
        tags:
            - "v*.*.*"

permissions:
    contents: write

jobs:
    build:
        name: Build Release Binaries
        runs-on: ubuntu-latest
        strategy:
            matrix:
                include:
                    - goos: linux
                      goarch: amd64
                    - goos: linux
                      goarch: arm64
                    - goos: darwin
                      goarch: amd64
                    - goos: darwin
                      goarch: arm64
                    - goos: windows
                      goarch: amd64

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Set up Go
              uses: actions/setup-go@v5
              with:
                  go-version: "1.24.x"
                  cache: true

            - name: Get version
              id: version
              run: |
                  VERSION=${GITHUB_REF#refs/tags/}
                  echo "version=${VERSION}" >> $GITHUB_OUTPUT
                  echo "Building version: ${VERSION}"

            - name: Build binary
              env:
                  GOOS: ${{ matrix.goos }}
                  GOARCH: ${{ matrix.goarch }}
                  VERSION: ${{ steps.version.outputs.version }}
              run: |
                  COMMIT=$(git rev-parse --short HEAD)
                  BUILD_TIME=$(date -u '+%Y-%m-%d_%H:%M:%S')
                  LDFLAGS="-X main.Version=${VERSION} -X main.Commit=${COMMIT} -X main.BuildTime=${BUILD_TIME}"

                  BINARY_NAME="inu"
                  if [ "${{ matrix.goos }}" = "windows" ]; then
                    BINARY_NAME="${BINARY_NAME}.exe"
                  fi

                  mkdir -p build
                  go build -ldflags "${LDFLAGS}" -o "build/${BINARY_NAME}" ./cmd/inu

                  # Package the binary
                  cd build
                  if [ "${{ matrix.goos }}" = "windows" ]; then
                    ARCHIVE_NAME="inu-${VERSION}-${{ matrix.goos }}-${{ matrix.goarch }}.zip"
                    zip "${ARCHIVE_NAME}" "${BINARY_NAME}"
                  else
                    ARCHIVE_NAME="inu-${VERSION}-${{ matrix.goos }}-${{ matrix.goarch }}.tar.gz"
                    tar czf "${ARCHIVE_NAME}" "${BINARY_NAME}"
                  fi

                  # Generate checksum
                  sha256sum "${ARCHIVE_NAME}" >> checksums.txt

                  echo "Created: ${ARCHIVE_NAME}"

            - name: Upload artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: inu-${{ matrix.goos }}-${{ matrix.goarch }}
                  path: build/*
                  retention-days: 1

    release:
        name: Create Release
        needs: build
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Get version
              id: version
              run: |
                  VERSION=${GITHUB_REF#refs/tags/}
                  echo "version=${VERSION}" >> $GITHUB_OUTPUT

            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  path: artifacts

            - name: Prepare release assets
              run: |
                  mkdir -p release
                  find artifacts -type f \( -name "*.tar.gz" -o -name "*.zip" \) -exec cp {} release/ \;

                  # Merge all checksums
                  find artifacts -name "checksums.txt" -exec cat {} \; > release/inu-${{ steps.version.outputs.version }}-checksums.txt

                  ls -lh release/

            - name: Generate release notes
              id: release_notes
              run: |
                  VERSION=${{ steps.version.outputs.version }}
                  cat > release_notes.md << EOF
                  ## Inu ${VERSION}

                  ### Installation

                  Download the appropriate binary for your platform:

                  **Linux (amd64)**
                  \`\`\`bash
                  curl -LO https://github.com/MrLYC/inu/releases/download/${VERSION}/inu-${VERSION}-linux-amd64.tar.gz
                  tar xzf inu-${VERSION}-linux-amd64.tar.gz
                  sudo mv inu /usr/local/bin/
                  \`\`\`

                  **Linux (arm64)**
                  \`\`\`bash
                  curl -LO https://github.com/MrLYC/inu/releases/download/${VERSION}/inu-${VERSION}-linux-arm64.tar.gz
                  tar xzf inu-${VERSION}-linux-arm64.tar.gz
                  sudo mv inu /usr/local/bin/
                  \`\`\`

                  **macOS (Intel)**
                  \`\`\`bash
                  curl -LO https://github.com/MrLYC/inu/releases/download/${VERSION}/inu-${VERSION}-darwin-amd64.tar.gz
                  tar xzf inu-${VERSION}-darwin-amd64.tar.gz
                  sudo mv inu /usr/local/bin/
                  \`\`\`

                  **macOS (Apple Silicon)**
                  \`\`\`bash
                  curl -LO https://github.com/MrLYC/inu/releases/download/${VERSION}/inu-${VERSION}-darwin-arm64.tar.gz
                  tar xzf inu-${VERSION}-darwin-arm64.tar.gz
                  sudo mv inu /usr/local/bin/
                  \`\`\`

                  **Windows (amd64)**
                  Download \`inu-${VERSION}-windows-amd64.zip\` and extract it to your desired location.

                  ### Verify Installation

                  \`\`\`bash
                  inu --version
                  \`\`\`

                  ### SHA256 Checksums

                  See \`inu-${VERSION}-checksums.txt\` for SHA256 checksums of all binaries.
                  EOF

                  cat release_notes.md

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  files: release/*
                  body_path: release_notes.md
                  draft: false
                  prerelease: false
                  generate_release_notes: true
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
